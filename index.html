<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard NPS Pro - Cloud Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIkQ-eXK_w01edPsMEdcwOMKU8ZRZkqfQ",
            authDomain: "dashboard-nps-b2954.firebaseapp.com",
            projectId: "dashboard-nps-b2954",
            storageBucket: "dashboard-nps-b2954.firebasestorage.app",
            messagingSenderId: "263315907578",
            appId: "1:263315907578:web:552a32493e5c8f74ae7a43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const npsCollection = collection(db, "avaliacoes");

        window.saveToFirebase = async (data) => {
            try {
                for (const item of data) { await addDoc(npsCollection, item); }
                return true;
            } catch (e) { return false; }
        };

        window.loadFromFirebase = async () => {
            try {
                const querySnapshot = await getDocs(query(npsCollection));
                const data = [];
                querySnapshot.forEach((doc) => data.push(doc.data()));
                return data;
            } catch (e) { return []; }
        };
    </script>

    <style>
        body { background-color: #0c0c0e; color: #e4e4e7; font-family: 'Inter', sans-serif; }
        .card { background-color: #18181b; border: 1px solid #27272a; border-radius: 12px; padding: 1.25rem; }
        .kpi-val { font-size: 1.875rem; font-weight: 700; color: #ffffff; }
        .kpi-label { font-size: 0.75rem; color: #a1a1aa; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem; }
        select, input { background: #18181b; border: 1px solid #3f3f46; color: #fff; padding: 0.5rem; border-radius: 8px; font-size: 0.875rem; outline: none; width: 100%; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .table-container { overflow-y: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; font-size: 0.7rem; color: #71717a; border-bottom: 1px solid #27272a; text-transform: uppercase; }
        td { padding: 10px; font-size: 0.8rem; border-bottom: 1px solid #27272a; }
        .scroll-v::-webkit-scrollbar { width: 4px; }
        .scroll-v::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        .badge-risk { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-[1500px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Dashboard NPS <span class="text-violet-500">Cloud</span></h1>
                <p id="cloud-status" class="text-zinc-500 text-sm italic">Iniciando conex√£o...</p>
            </div>
            <div class="flex gap-2">
                <div class="card flex items-center gap-3 py-2 px-4">
                    <span class="text-xs font-bold text-zinc-400">CSV:</span>
                    <input type="file" id="csv-upload" accept=".csv" class="text-xs cursor-pointer">
                </div>
                <button id="btn-sync" onclick="syncWithFirebase()" class="hidden bg-violet-600 hover:bg-violet-700 text-white text-xs font-bold py-2 px-6 rounded-lg transition shadow-lg">SALVAR NA NUVEM</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="flex flex-col gap-1"><label class="text-[10px] font-bold text-zinc-500 uppercase ml-1">Data In√≠cio</label><input type="date" id="f-start-date" onchange="update()"></div>
            <div class="flex flex-col gap-1"><label class="text-[10px] font-bold text-zinc-500 uppercase ml-1">Data T√©rmino</label><input type="date" id="f-end-date" onchange="update()"></div>
            <div class="flex flex-col gap-1"><label class="text-[10px] font-bold text-zinc-500 uppercase ml-1">Setor</label><select id="f-dept" onchange="update()"><option value="all">Todos os Setores</option></select></div>
            <div class="flex flex-col gap-1"><label class="text-[10px] font-bold text-zinc-500 uppercase ml-1">Atendente</label><select id="f-agent" onchange="update()"><option value="all">Todos os Atendentes</option></select></div>
            <div class="flex flex-col gap-1"><label class="text-[10px] font-bold text-zinc-500 uppercase ml-1">Pesquisar</label><input type="text" id="f-search" placeholder="Cliente..." oninput="update()"></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="card"><div class="kpi-label">NPS</div><div id="v-nps" class="kpi-val text-violet-400">-</div></div>
            <div class="card"><div class="kpi-label">M√©dia</div><div id="v-avg" class="kpi-val">-</div></div>
            <div class="card border-l-4 border-red-500"><div class="kpi-label text-red-400">Churn</div><div id="v-churn" class="kpi-val text-red-500">-</div></div>
            <div class="card"><div class="kpi-label">Total</div><div id="v-total" class="kpi-val">-</div></div>
            <div class="card"><div class="kpi-label">Taxa Eval</div><div id="v-rate" class="kpi-val">-</div></div>
            <div class="card"><div class="kpi-label">Detratores</div><div id="v-dets" class="kpi-val text-red-500">-</div></div>
        </div>

        <div class="card mb-8">
            <h3 class="kpi-label mb-4 text-red-500 font-bold">üîç DETALHAMENTO DE RISCO (CHURN)</h3>
            <div class="table-container scroll-v max-h-64">
                <table id="t-churn-details">
                    <thead><tr><th>Cliente</th><th>√öltima Nota</th><th>Classifica√ß√£o</th><th>Tickets</th><th>Risco %</th><th>Status</th></tr></thead>
                    <tbody class="text-sm"></tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card lg:col-span-1"><h3 class="kpi-label mb-4">Composi√ß√£o</h3><div class="h-[250px]"><canvas id="c-pie"></canvas></div></div>
            <div class="card lg:col-span-2"><h3 class="kpi-label mb-4">Evolu√ß√£o NPS</h3><div class="h-[250px]"><canvas id="c-line"></canvas></div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card"><h3 class="kpi-label mb-4 text-violet-400">Clientes Mais Frequentes</h3><div class="table-container scroll-v h-64"><table id="t-top-clients" class="w-full"><tbody></tbody></table></div></div>
            <div class="card"><h3 class="kpi-label mb-4 text-red-400">Lista Detratores</h3><div class="table-container scroll-v h-64"><table id="t-det-list" class="w-full"><tbody></tbody></table></div></div>
            <div class="card flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="kpi-label !mb-0">11. Feedbacks</h3>
                    <select id="f-motive-class" onchange="update()" class="!w-auto !py-1 !px-2 !text-[10px] !bg-zinc-800 border-none">
                    <option value="all">Todos</option><option value="Promotor">Promotores</option><option value="Detrator">Detratores</option><option value="Neutro">Neutros</option></select>
                </div>
                <div id="l-motives" class="table-container scroll-v h-64 space-y-3 pr-2"></div>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let charts = {};
        let tempCSV = [];

        async function init() {
            document.getElementById('cloud-status').innerText = "Carregando dados da nuvem...";
            try {
                const data = await window.loadFromFirebase();
                rawData = data || [];
                document.getElementById('cloud-status').innerText = rawData.length > 0 ? `${rawData.length} registros ativos na nuvem.` : "Banco vazio. Importe um CSV.";
            } catch (e) {
                document.getElementById('cloud-status').innerText = "Erro ao carregar nuvem.";
            }
            setupFilters(rawData);
            update();
            document.getElementById('csv-upload').addEventListener('change', handleFile);
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: function(res) {
                    tempCSV = res.data.map(r => {
                        let nRaw = r['Nota'] ? String(r['Nota']).replace(',', '.').trim() : '';
                        let dRaw = r['Data de fechamento do chamado'] || '';
                        let dt = '';
                        if(dRaw.includes('/')) { const p = dRaw.split(' ')[0].split('/'); dt = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
                        return {
                            Data_Fechamento: dt,
                            Contato: r['Contato'] || 'An√¥nimo',
                            Nome_Atendente: r['Nome do atendente'] || 'N√£o identificado',
                            Departamento: r['Departamentos do chamado'] || 'Geral',
                            Nota_numeric: !isNaN(parseFloat(nRaw)) ? parseFloat(nRaw) : null,
                            Classifica√ß√£o: r['Classifica√ß√£o'] || 'N√£o avaliado',
                            Motivo: r['Motivo'] || ''
                        };
                    }).filter(r => r.Data_Fechamento);
                    rawData = [...rawData, ...tempCSV];
                    document.getElementById('btn-sync').classList.remove('hidden');
                    setupFilters(rawData);
                    update();
                }
            });
        }

        async function syncWithFirebase() {
            const btn = document.getElementById('btn-sync');
            btn.innerText = "Sincronizando...";
            const ok = await window.saveToFirebase(tempCSV);
            if(ok) { alert("Sincronizado com o Firebase!"); btn.classList.add('hidden'); location.reload(); } 
            else { alert("Erro ao salvar."); btn.innerText = "Tentar Novamente"; }
        }

        function setupFilters(data) {
            const depts = [...new Set(data.map(r => r.Departamento))].sort();
            const agents = [...new Set(data.map(r => r.Nome_Atendente))].sort();
            fillSelect('f-dept', depts, 'Todos');
            fillSelect('f-agent', agents, 'Todos');
        }

        function fillSelect(id, items, def) {
            const s = document.getElementById(id);
            const val = s.value;
            s.innerHTML = `<option value="all">${def}</option>`;
            items.forEach(i => s.add(new Option(i, i)));
            if([...s.options].some(o => o.value === val)) s.value = val;
        }

        function update() {
            const sd = document.getElementById('f-start-date').value;
            const ed = document.getElementById('f-end-date').value;
            const dp = document.getElementById('f-dept').value;
            const ag = document.getElementById('f-agent').value;
            const sc = document.getElementById('f-search').value.toLowerCase();
            const mc = document.getElementById('f-motive-class').value;

            const filtered = rawData.filter(r => {
                const dtOk = (sd === '' || r.Data_Fechamento >= sd) && (ed === '' || r.Data_Fechamento <= ed);
                return dtOk && (dp === 'all' || r.Departamento === dp) && (ag === 'all' || r.Nome_Atendente === ag) && (sc === '' || r.Contato.toLowerCase().includes(sc));
            });

            renderKPIs(filtered);
            renderChurn(filtered);
            renderCharts(filtered);
            renderTables(filtered, mc);
        }

        function renderKPIs(data) {
            const ev = data.filter(r => r.Classifica√ß√£o !== 'N√£o avaliado');
            const p = ev.filter(r => r.Classifica√ß√£o === 'Promotor').length;
            const d = ev.filter(r => r.Classifica√ß√£o === 'Detrator').length;
            const nps = ev.length ? ((p-d)/ev.length)*100 : 0;
            const nts = data.filter(r => r.Nota_numeric !== null).map(r => r.Nota_numeric);
            const avg = nts.length ? nts.reduce((a,b)=>a+b,0)/nts.length : 0;

            document.getElementById('v-nps').innerText = nps.toFixed(1);
            document.getElementById('v-avg').innerText = avg.toFixed(1);
            document.getElementById('v-total').innerText = data.length;
            document.getElementById('v-rate').innerText = data.length ? ((ev.length/data.length)*100).toFixed(1)+'%' : '0%';
            document.getElementById('v-dets').innerText = d;
        }

        function renderChurn(data) {
            const cli = {};
            data.forEach(r => {
                if(!cli[r.Contato]) cli[r.Contato] = { n: [], c: [], t: 0 };
                cli[r.Contato].t++;
                if(r.Nota_numeric !== null) cli[r.Contato].n.push(r.Nota_numeric);
                cli[r.Contato].c.push(r.Classifica√ß√£o);
            });

            const churn = Object.entries(cli).map(([name, s]) => {
                let p = 0;
                const lc = s.c[s.c.length-1];
                const ln = s.n[s.n.length-1];
                if(lc === 'Detrator') p += 65; else if(lc === 'Neutro') p += 30;
                if(ln !== undefined && ln <= 4) p += 25;
                p = Math.min(p, 99);
                return { name, ln: ln ?? '-', lc, t: s.t, p };
            }).filter(c => c.p >= 30).sort((a,b)=>b.p-a.p).slice(0, 15);

            document.getElementById('v-churn').innerText = churn.length;
            document.querySelector('#t-churn-details tbody').innerHTML = churn.map(c => `
                <tr class="${c.p > 70 ? 'bg-red-900/10' : ''}">
                    <td class="font-bold">${c.name}</td><td>${c.ln}</td>
                    <td class="${c.lc === 'Detrator' ? 'text-red-500' : 'text-amber-500'}">${c.lc}</td>
                    <td>${c.t}</td><td>${c.p}%</td>
                    <td><span class="badge-risk ${c.p > 70 ? 'bg-red-500 text-white' : 'bg-amber-500 text-black'}">${c.p > 70 ? 'CR√çTICO' : 'ATEN√á√ÉO'}</span></td>
                </tr>`).join('');
        }

        function renderCharts(data) {
            const ct = { 'Promotor': 0, 'Detrator': 0, 'Neutro': 0, 'N√£o avaliado': 0 };
            data.forEach(r => ct[r.Classifica√ß√£o]++);
            updateChart('c-pie', 'doughnut', { labels: Object.keys(ct), datasets: [{ data: Object.values(ct), backgroundColor: ['#10b981','#ef4444','#f59e0b','#3f3f46'], borderWidth: 0 }] }, { cutout: '75%', plugins: { legend: { position: 'bottom' } } });
            
            const dts = [...new Set(data.map(r => r.Data_Fechamento))].sort();
            const npsL = dts.map(dt => {
                const dy = data.filter(r => r.Data_Fechamento === dt && r.Classifica√ß√£o !== 'N√£o avaliado');
                if(!dy.length) return null;
                const p = dy.filter(r => r.Classifica√ß√£o === 'Promotor').length;
                const d = dy.filter(r => r.Classifica√ß√£o === 'Detrator').length;
                return ((p-d)/dy.length)*100;
            });
            updateChart('c-line', 'line', { labels: dts, datasets: [{ label: 'NPS', data: npsL, borderColor: '#8b5cf6', tension: 0.3, pointRadius: 2 }] });
        }

        function renderTables(data, mc) {
            const map = {}; data.forEach(r => map[r.Contato] = (map[r.Contato] || 0) + 1);
            const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0, 15);
            document.querySelector('#t-top-clients tbody').innerHTML = top.map(x => `<tr><td>${x[0]}</td><td class="font-bold text-right">${x[1]}</td></tr>`).join('');
            
            const det = data.filter(r => r.Classifica√ß√£o === 'Detrator').reverse().slice(0, 15);
            document.querySelector('#t-det-list tbody').innerHTML = det.map(x => `<tr><td class="text-red-400">${x.Contato}</td><td class="font-bold text-right">${x.Nota_numeric ?? '-'}</td></tr>`).join('');
            
            let mot = data.filter(r => r.Motivo);
            if(mc !== 'all') mot = mot.filter(m => m.Classifica√ß√£o === mc);
            document.getElementById('l-motives').innerHTML = mot.reverse().map(m => {
                let colorClass = 'text-zinc-400';
                if(m.Classifica√ß√£o === 'Promotor') colorClass = 'text-emerald-500';
                else if(m.Classifica√ß√£o === 'Detrator') colorClass = 'text-red-500';
                else if(m.Classifica√ß√£o === 'Neutro') colorClass = 'text-amber-500';
                return `<div class="bg-zinc-900 p-3 rounded-lg border border-zinc-800 text-[11px] mb-2"><div class="flex justify-between font-bold mb-1"><span class="${colorClass}">${m.Classifica√ß√£o.toUpperCase()}</span><span class="text-zinc-500">${m.Data_Fechamento}</span></div><p class="italic text-zinc-200">"${m.Motivo}"</p><div class="text-[9px] text-zinc-500 mt-2">${m.Contato}</div></div>`;
            }).join('');
        }

        function updateChart(id, type, data, opt) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...opt } });
        }
        window.onload = init;
    </script>
</body>
</html>